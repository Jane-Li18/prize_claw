
{% load static %}
{% block content %}

<style>
    .content-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 50px;
        background-color: #fff;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        width: 100%;
        box-sizing: border-box;
    }

    #header-container {
        text-align: center;
    }

    #info-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        max-width: 500px;
        margin: 0 auto;
    }

    #timer-container {
        display: flex;
        align-items: center;
    }

    #timer-icon {
        font-size: 24px;
        margin-right: 5px;
    }

    #game-area {
        position: relative;
        width: 100%;
        max-width: 500px;
        height: 400px;
        border: 1px solid #cccc;
        background-color: #fff;
        margin: 0 auto;
        overflow: hidden;
    }

    #claw {
        width: 30px;
        height: 60px;
        position: absolute;
        top: 30px;
        left: calc(50% - 15px);
        z-index: 5;
        transition: left 0.3s ease-out;
    }
    
    #claw-base {
        width: 30px;
        height: 10px;
        background: #666;
        border-radius: 5px;
        position: relative;
        transition: transform 0.2s ease;
    }
    
    #claw-arms {
        width: 40px;
        height: 40px;
        position: absolute;
        top: 10px;
        left: -5px;
    }
    
    .claw-arm {
        width: 10px; /* Increased width for a better C shape */
        height: 30px;
        background: #444;
        position: absolute;
        top: 0;
        transition: transform 0.2s ease;
        border-radius: 5px; /* Rounded edges */
    }
    
    #left-arm {
        left: 0;
        transform-origin: top center;
        border-top-left-radius: 15px; /* Rounded top left corner */
        border-bottom-left-radius: 15px; /* Rounded bottom left corner */
    }
    
    #right-arm {
        right: 0;
        transform-origin: top center;
        border-top-right-radius: 15px; /* Rounded top right corner */
        border-bottom-right-radius: 15px; /* Rounded bottom right corner */
    }
    
    /* Inner C shape for left arm */
    #left-arm::before {
        content: '';
        position: absolute;
        width: 5px;
        height: 20px;
        background: white;
        border-top-left-radius: 15px;
        border-bottom-left-radius: 15px;
        top: 7px;
        left: 5px;
    }
    
    /* Inner C shape for right arm */
    #right-arm::before {
        content: '';
        position: absolute;
        width: 5px;
        height: 20px;
        background: white;
        border-top-right-radius: 15px;
        border-bottom-right-radius: 15px;
        top: 7px;
        right: 5px;
    }
    
    /* Optional: Add a grabbing effect */
    .claw-arm.grab {
        transform: rotate(45deg); /* Adjust the angle for grabbing */
    }
    
    .claw-arm.grab-left {
        transform: rotate(-45deg); /* Adjust the angle for grabbing */
    }

    #play-button {
        display: inline-block;
        height: 60px;
        width: 180px;
        padding: 0;
        text-align: center;
        font-size: 20px;
    }



    .prize {
        width: 10%; 
        height: auto;
        max-width: 60px; 
        max-height: 60px;
        border-radius: 50%;
        position: absolute;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        z-index: 5;
        transition: transform 0.5s ease, bottom 0.5s ease;
        bottom: 20px; /* Keep prizes above the floor */
    }
    
    .prize img {
        width: 105%; 
        height: auto; 
        display: block;
        margin: 0 auto;
        position: relative;
    }

    .prize.grabbed {
        transition: transform 0.5s cubic-bezier(0.33, 1, 0.68, 1), top 0.5s cubic-bezier(0.33, 1, 0.68, 1);
        z-index: 15;
    }
    
    #controls {
        margin-top: 10px;
    }

    .move-button {
        margin: 0 5px;
        padding: 8px 15px;
    }

    .grabbing #left-arm {
        transform: rotate(-20deg);
    }

    .grabbing #right-arm {
        transform: rotate(20deg);
    }

    .moving-down {
        animation: moveDown 1s cubic-bezier(0.33, 1, 0.68, 1) forwards;
    }

    .moving-up {
        animation: moveUp 1s cubic-bezier(0.33, 1, 0.68, 1) forwards;
    }

    @keyframes moveDown {
        0% { top: 30px; } 
        100% { top: calc(100% - 60px - 20px); } 
    }
    
    @keyframes moveUp {
        0% { top: calc(100% - 60px - 20px); } 
        100% { top: 30px; } 
    }

    #timer {
        font-weight: bold;
        margin: 10px 0;
        color: red;
    }

    .slider-container {
        width: 200px;
        margin: 10px auto;
    }

    .prize.falling {
        transition: bottom 0.8s cubic-bezier(0.4, 0, 0.6, 1), transform 0.3s ease;
        z-index: 20;
    }

    #prize-floor {
        position: absolute;
        width: 100%;
        height: 30px;
        background-color: #555;
        bottom: 0;
        z-index: 1;
    }

    #game-over {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: var(--bg-primary);
        color: var(--txt-primary);
        text-align: center;
        padding: 20px;
        border-radius: 10px;
        z-index: 500;
        display: none;
        width: 90%;
        max-width: 500px;
        border: 1px solid #cccc;
    }

    .input-container {
        margin-top: 10px;
    }
    
    .button-container {
        margin-top: 15px;
    }
    
    {% comment %} #submit-btn {
        background-color: #5bc0de;
        color: var(--bg-primary);
    } {% endcomment %}

    button:disabled {
        background-color: #cccccc !important;
        color: #666666 !important;
        cursor: not-allowed !important;
        border-color: #cccccc !important;
    }

    .active-mode:disabled {
        background-color: #4CAF50 !important;
        color: white !important;
        border-color: #4CAF50 !important;
    }

    .active-mode {
        background-color: #4CAF50 !important;
        color: white !important;
        border-color: #4CAF50 !important;
    }

    #cable-drum {
        position: absolute;
        width: 60px;
        height: 20px;
        background-color: #555;
        border-radius: 10px;
        top: 5px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 50;
        transition: left 0.3s ease-out;
    }

    #cable-drum:before {
        content: "";
        position: absolute;
        width: 10px;
        height: 20px;
        background-color: #333;
        top: -20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 6;
    }

    #claw-wire {
        position: absolute;
        width: 2px;
        background-color: #888;
        height: 300px;
        top: -330px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 8;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
    }

    #controls-container {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 20px auto;
        width: 100%;
        max-width: 500px;
    }

    .joystick-container {
        position: relative;
        width: 150px;
        height: 60px;
        background: #dddd;
        border-radius: 30px;
        margin-right: 10px;
        padding: 10px 20px;
    }

    #positionSlider {
        -webkit-appearance: none;
        width: 100%;
        height: 4px;
        border-radius: 2px;
        outline: none;
        margin-top: 18px;
    }

    #positionSlider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 40px;
        height: 40px;
        background: transparent;
        border: none;
        cursor: pointer;
        background-image: url('/static/Prizes/Joy_Stick_Ball.png');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
    }
    

    #positionSlider::-moz-range-thumb {
        width: 60px;
        height: 60px;
        background: transparent;
        border: none;
        cursor: pointer;
        background-image: url('Prizes/Joy_Stick.png');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
    }

    .joystick-slider {
        transition: transform 0.1s ease-out;
    }

    .joystick-slider::-webkit-slider-thumb {
        transition: transform 0.1s ease-out;
    }

    .joystick-slider::-moz-range-thumb {
        transition: transform 0.1s ease-out;
    }

    @keyframes fall {
        0% {
            top: var(--fall-start-top);
            left: var(--fall-start-left);
        }
        100% {
            top: calc(100% - 80px);
            left: var(--fall-start-left);
        }
    }

    .prize.falling {
        animation: fall 0.5s ease forwards;
    }

    @keyframes bounce {
        0% {
            transform: translateY(0) rotate(var(--rotation));
        }
        50% {
            transform: translateY(-10px) rotate(var(--rotation));
        }
        100% {
            transform: translateY(0) rotate(var(--rotation));
        }
    }

    .bounce {
        animation: bounce 0.5s ease;
        transform: rotate(var(--rotation));
    }

    /* Responsive Styles */
    @media (max-width: 768px) {
        .content-container {
            padding: 20px;
        }

        #game-area {
            height: 350px;
        }

        #controls-container {
            align-items: center;
            gap: 0px;
        }

        #game-over {
            width: 80%;
        }
    }

    @media (max-width: 320px) {
        .content-container {
            padding: 10px;
        }

        #game-area {
            height: 300px;
        }

        #game-over {
            width: 90%;
        }
    }
</style>

<title>{% block title %}Prize Claw Machine{% endblock title %}</title>

    <div id="header-container">
        <div id="info-container">
            <div id="score-display">Prizes: 0</div>
            <div id="timer-container">
                <span id="timer-icon">⏰</span>
                <div id="timer">20</div>
            </div>
        </div>
    </div>
    <div id="game-area">
        <div id="cable-drum"></div>
        <div id="claw">
            <div id="claw-wire"></div>
            <div id="claw-base"></div>
            <div id="claw-arms">
                <div id="left-arm" class="claw-arm"></div>
                <div id="right-arm" class="claw-arm"></div>
            </div>
        </div>
    
        <div id="prize-floor"></div>
    
        {% if prizes %}
        {% for prize in prizes %}
            <div class="prize" style="display: none;">
                {% if prize.image %}
                    <img src="{{ prize.image.url }}" alt="{{ prize.name }}" class="prize-image">
                {% endif %}
            </div>
        {% endfor %}
        {% else %}
            <div class="prize">
                <img src="{% static 'prizes/Pink_Rabbit.png' %}" alt="Kairobot" class="prize-image">
            </div>
            <div class="prize">
                <img src="{% static 'prizes/MisterX.png' %}" alt="MisterX" class="prize-image">
            </div>
            <div class="prize">
                <img src="{% static 'prizes/Grizzly.png' %}" alt="Grizzly" class="prize-image">
            </div>
            <div class="prize">
                <img src="{% static 'prizes/Wairobot.png' %}" alt="Wairobot" class="prize-image">
            </div>
        {% endif %}
    

    <div id="game-over">
        <h2>Time's Up!</h2>
        <span>You collected <span id="final-score">0</span> prizes!</span>
        <div class="input-container">
            <input type="text" id="player-name" placeholder="Enter your name" required style="text-align: center;">
        </div>
        <div class="button-container">
            <button id="submit-btn" class="btn" type="button" onclick="submitScore()">SUBMIT &nbsp;<i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>

    </div>
    <div id="controls-container" >
        <div class="joystick-container">
            <input type="range" id="positionSlider" min="0" max="100" value="50" class="joystick-slider">
        </div>
        <button id="play-button" onclick="startGame()">START!</button>
    </div>
    <div style="text-align: center; margin-bottom: 10px;">
        <button id="challenge-btn" onclick="startChallengeMode()">Challenge Mode</button>
        <button id="normal-btn" onclick="switchToNormalMode()">Normal Mode</button>
    </div>
    

    

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const claw = document.getElementById('claw');
            const clawArms = document.getElementById('claw-arms');
            const playButton = document.getElementById('play-button');
            const scoreElement = document.getElementById('score-display');
            const timerElement = document.getElementById('timer');
            const slider = document.getElementById('positionSlider');
            const knob = document.querySelector('.joystick-knob');
            const gameOverElement = document.getElementById('game-over');
            const finalScoreElement = document.getElementById('final-score');
            const playAgainBtn = document.getElementById('submit-btn');
            const challengeBtn = document.getElementById('challenge-btn');
            const normalBtn = document.getElementById('normal-btn');
            
            const gameArea = document.getElementById('game-area');
            
            let clawPosition = 50;
            let isAnimating = false;
            let score = 0;
            let grabbedPrize = null;
            let prizes = Array.from(document.querySelectorAll('.prize'));
            let gameTimer;
            let timeLeft = 20;
            let gameActive = false;
            let challengeMode = localStorage.getItem('gameMode') === 'challenge';
            let autoMoveInterval;
            let moveDirection = 'right';
            let wireLength = 100; // Initial wire length
    
            let storedMode = localStorage.getItem('gameMode');
            challengeMode = storedMode === 'challenge';

            // Add to mode switching functions:
            challengeBtn.classList.toggle('active-mode', challengeMode);
            normalBtn.classList.toggle('active-mode', !challengeMode);

        
            // Set initial button states based on loaded mode
            if (challengeMode) {
                challengeBtn.disabled = true;
                normalBtn.disabled = false;
                challengeBtn.classList.add('active-mode');
            } else {
                challengeBtn.disabled = false;
                normalBtn.disabled = true;
                normalBtn.classList.add('active-mode');
            }

            function updateWire() {
                const claw = document.getElementById('claw');
                const wire = document.getElementById('claw-wire');
                const clawTop = claw.offsetTop;
                
                // Calculate wire length based on claw position
                wireLength = clawTop + 300;
                wire.style.height = `${wireLength}px`;
            }
    
            function moveClawDown() {
                if (!gameActive) return;
            
                const claw = document.getElementById('claw');
                claw.classList.add('grabbing');
                claw.classList.add('moving-down');
                claw.classList.remove('moving-up');
            
                const wireUpdateInterval = setInterval(updateWire, 10);
            
                setTimeout(() => {
                    claw.classList.remove('moving-down');
                    checkPrizeGrab();
                    moveClawUp();
                    clearInterval(wireUpdateInterval);
                }, 1000); // Duration of the down movement
            }
            
            function moveClawUp() {
                const claw = document.getElementById('claw');
                claw.classList.add('moving-up');
                claw.classList.remove('moving-down');
            
                const wireUpdateInterval = setInterval(updateWire, 10);
            
                setTimeout(() => {
                    claw.classList.remove('moving-up');
                    claw.classList.remove('grabbing');
                    clearInterval(wireUpdateInterval);
                    if (gameActive) {
                        playButton.disabled = false;
                        playButton.textContent = "GRAB!";
                    }
                }, 1000); // Duration of the up movement
            }
    
            function checkPrizeGrab() {
                const clawRect = claw.getBoundingClientRect();
                prizes.forEach(prize => {
                    if (prize.isGrabbed || grabbedPrize) return;
                    const prizeRect = prize.getBoundingClientRect();
    
                    if (clawRect.bottom >= prizeRect.top + 30 &&
                        clawRect.left <= prizeRect.right - 10 &&
                        clawRect.right >= prizeRect.left + 10) {
                        
                        clawArms.classList.add('grabbing');
                        grabbedPrize = prize;
                        prize.isGrabbed = true;
                        prize.style.transition = 'none';
                        prize.style.zIndex = 100;
                        followClaw();
                    }
                });
            }
    
            function followClaw() {
                if (grabbedPrize) {
                    const claw = document.getElementById('claw');
                    const clawY = claw.offsetTop;
                    const clawX = claw.offsetLeft;
                    const prizeWidth = grabbedPrize.offsetWidth;
    
                    grabbedPrize.style.left = `${clawX - prizeWidth / 2 + 15}px`;
                    grabbedPrize.style.top = `${clawY + 30}px`;
                    
                    const wire = document.getElementById('claw-wire');
                    const swingAmount = Math.sin(Date.now() / 150) * 4;
                    wire.style.transform = `translateX(calc(-50% + ${swingAmount}px))`;
                    
                    const clawBase = document.getElementById('claw-base');
                    const baseSwing = Math.sin(Date.now() / 180) * 5;
                    clawBase.style.transform = `translateX(${swingAmount * 0.5}px) rotate(${baseSwing}deg)`;
                    
                    requestAnimationFrame(followClaw);
                } else {
                    const wire = document.getElementById('claw-wire');
                    const clawBase = document.getElementById('claw-base');
                    wire.style.transform = 'translateX(-50%)';
                    clawBase.style.transform = 'translateX(0) rotate(0deg)';
                }
            }
    
            function updateClawPosition() {
                // Set claw position using percentage
                const newLeft = `calc(${clawPosition}% - 15px)`;
                claw.style.left = newLeft;
                
                // Update cable drum position
                const cableDrum = document.getElementById('cable-drum');
                cableDrum.style.left = `calc(${clawPosition}% - 30px)`;
                
                // Add slight rotation effect
                const rotation = (clawPosition - 50) / 5;
                cableDrum.style.transform = `translateX(0) rotate(${rotation}deg)`;
                
                // Update grabbed prize position if any
                if (grabbedPrize) {
                    const prizeWidth = grabbedPrize.offsetWidth;
                    grabbedPrize.style.left = `calc(${clawPosition}% - ${prizeWidth / 2}px)`;
                }
            }
        
            let isDragging = false;

            let lastUpdate = 0;
            const throttleDelay = 33; // ~30 FPS (1000ms / 30)
            
            slider.addEventListener('input', function(e) {
                if (isAnimating || !gameActive || challengeMode) return;
                
                const now = Date.now();
                if (now - lastUpdate < throttleDelay) return; // Skip if too soon
                
                lastUpdate = now;
                clawPosition = parseInt(e.target.value);
                updateClawPosition();
            });
            
            
            slider.addEventListener('mouseup', () => { 
                isDragging = false;
                resetJoystickPosition(); 
            });
            slider.addEventListener('touchend', () => { 
                isDragging = false;
                resetJoystickPosition(); 
            });

            function updateClawSmoothly() {
                if (!isDragging) return; // Stop if dragging ended
                clawPosition = parseInt(slider.value);
                updateClawPosition();
                requestAnimationFrame(updateClawSmoothly); // Keep updating smoothly
            }
            
            function resetJoystickPosition() {
                if (challengeMode) return;
                slider.value = 50; // Reset slider (claw stays in place)
            }
                    
            function moveClaw(direction) {
                if (isAnimating || !gameActive || challengeMode) return;
            
                if (direction === 'left' && clawPosition > 0) {
                    clawPosition -= 10;
                } else if (direction === 'right' && clawPosition < 100) {
                    clawPosition += 10;
                }
            
                updateClawPosition();
                slider.value = clawPosition;
                
                // Explicitly update cable drum position
                updateCableDrum();
            }
    
            function autoMoveClaw() {
                if (moveDirection === 'right') {
                    clawPosition += 2;
                    if (clawPosition >= 100) {
                        moveDirection = 'left';
                    }
                } else {
                    clawPosition -= 2;
                    if (clawPosition <= 0) {
                        moveDirection = 'right';
                    }
                }
                
                updateClawPosition();
                slider.value = clawPosition;
            }
        
            function playGame() {
                if (isAnimating || !gameActive) return;
                isAnimating = true;
                playButton.disabled = true;
            
                clawArms.classList.remove('grabbing');
                claw.classList.add('moving-down');
            
                setTimeout(() => {
                    checkPrizeGrab();
                    claw.classList.remove('moving-down');
                    claw.classList.add('moving-up');
            
                    setTimeout(() => {
                        if (grabbedPrize) {
                            // Introduce a 30% chance of the prize dropping
                            const dropChance = Math.random();
                            if (dropChance < .4) { // Adjusted to 30% chance
                                // Prize drops, animate it to the prize floor
                                const prizeTop = grabbedPrize.getBoundingClientRect().top - gameArea.getBoundingClientRect().top;
                                const prizeLeft = grabbedPrize.getBoundingClientRect().left - gameArea.getBoundingClientRect().left;
            
                                // Set the starting position of the prize
                                grabbedPrize.style.setProperty('--fall-start-top', `${prizeTop}px`);
                                grabbedPrize.style.setProperty('--fall-start-left', `${prizeLeft}px`);
            
                                // Add rotation based on momentum (randomized for now)
                                const rotation = (Math.random() * 360) + 'deg'; // Random rotation between 0 and 360 degrees
                                grabbedPrize.style.setProperty('--rotation', rotation); // Set the rotation
            
                                grabbedPrize.classList.add('falling'); // Add falling animation
            
                                // Wait for the falling animation to complete
                                grabbedPrize.addEventListener('animationend', () => {
                                    grabbedPrize.classList.remove('falling'); // Remove falling animation
            
                                    // Calculate the correct position for the prize on the floor
                                    const prizeHeight = grabbedPrize.offsetHeight; // Height of the prize
                                    const gameAreaHeight = gameArea.offsetHeight; // Height of the game area
                                    const offset = 25; // Adjust this value to control the height above the floor
                                    const floorPosition = gameAreaHeight - prizeHeight - offset; // Position the prize on the floor
            
                                    grabbedPrize.style.position = 'absolute'; // Ensure the prize is positioned absolutely
                                    grabbedPrize.style.top = `${floorPosition}px`; // Position the prize on the floor
                                    grabbedPrize.style.left = `${prizeLeft}px`; // Maintain the horizontal position
                                    grabbedPrize.isGrabbed = false; // Mark as not grabbed
                                    grabbedPrize.classList.add('bounce'); // Add bounce effect
                                    setTimeout(() => grabbedPrize.classList.remove('bounce'), 500); // Remove bounce after animation
                                    grabbedPrize = null; // Reset grabbed prize
                                    clawArms.classList.remove('grabbing');
                                }, { once: true }); // Ensure the event listener is removed after execution
                            } else {
                                // Prize is successfully grabbed
                                score++;
                                scoreElement.textContent = `Prizes: ${score}`;
                                grabbedPrize.remove();
                                prizes = prizes.filter(p => p !== grabbedPrize);
                                grabbedPrize = null;
            
                                if (prizes.length === 0) {
                                    regeneratePrizes();
                                }
                            }
                        }
            
                        clawArms.classList.remove('grabbing');
                        claw.classList.remove('moving-up');
                        isAnimating = false;
                        playButton.disabled = false;
                    }, 1000);
                }, 1000);
            }
        
            function preloadImages(images, callback) {
                let loaded = 0;
                images.forEach(src => {
                    const img = new Image();
                    img.src = src;
                    img.onload = () => {
                        loaded++;
                        if (loaded === images.length) callback();
                    };
                });
            }
            
            function regeneratePrizes() {
                fetch('/claw_machine/', {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest' // Add this header
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json(); // Parse the response as JSON
                })
                .then(data => {
                    // Combine built-in and database prizes
                    const builtInPrizes = [
                        '{% static "prizes/Pink_Rabbit.png" %}',
                        '{% static "prizes/MisterX.png" %}',
                        '{% static "prizes/Grizzly.png" %}',
                        '{% static "prizes/Wairobot.png" %}'
                    ];
            
                    // Combine built-in prizes with fetched prizes
                    const allPrizes = builtInPrizes.concat(data.prizes.map(prize => prize.image));
            
                    // Limit the total number of prizes to 6
                    const limitedPrizes = allPrizes.length > 10 ? allPrizes.slice(0, 10) : allPrizes;
            
                    // Clear existing prizes
                    document.querySelectorAll('.prize').forEach(prize => prize.remove());
            
                    // Add new prizes
                    limitedPrizes.forEach(imgSrc => {
                        const newPrize = document.createElement('div');
                        newPrize.className = 'prize';
            
                        const img = document.createElement('img');
                        img.src = imgSrc;
                        img.className = 'prize-image';
                        img.alt = imgSrc.split('/').pop().replace('.png', '');
            
                        newPrize.appendChild(img);
                        document.getElementById('game-area').appendChild(newPrize);
                    });
            
                    // Update the prizes array to include the new prizes
                    prizes = Array.from(document.querySelectorAll('.prize'));
            
                    // Reinitialize prize positions
                    randomizePrizePositions();
                })
                .catch(error => console.error('Error fetching prizes:', error));
            }
            
            
        
            function randomizePrizePositions() {
                const prizeWidth = 60; // Maximum width of the prize
                const gameAreaWidth = gameArea.offsetWidth; // Width of the game area
                const gameAreaHeight = gameArea.offsetHeight; // Height of the game area
                const maxLeft = gameAreaWidth - prizeWidth; // Maximum left position for the prize
                const positions = [];
                const maxAttempts = 100;
            
                prizes.forEach(prize => {
                    let newLeft;
                    let isOverlapping;
                    let attempts = 0;
            
                    do {
                        newLeft = Math.floor(Math.random() * maxLeft);
                        isOverlapping = positions.some(pos => Math.abs(newLeft - pos) < prizeWidth);
                        attempts++;
            
                        if (attempts > maxAttempts) {
                            isOverlapping = false;
                            console.warn("Couldn't find non-overlapping position for prize");
                        }
                    } while (isOverlapping && attempts <= maxAttempts);
            
                    positions.push(newLeft);
                    prize.style.left = `${newLeft}px`;
                    prize.style.bottom = '20px'; // Keep prizes above the floor
                });
            }
        
            function updateTimer() {
                timeLeft--;
                timerElement.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    endGame();
                } else {
                    gameTimer = setTimeout(updateTimer, 1000);
                }
            }
        
            function endGame() {
                gameActive = false;
                clearTimeout(gameTimer);
                if (challengeMode) {
                    clearInterval(autoMoveInterval);
                }
                finalScoreElement.textContent = score;
                gameOverElement.style.display = 'block';
            
            }
            
            
        
            function startGame() {
                if (gameActive) return;
                
                gameActive = true;
                playButton.textContent = "GRAB!";
                playButton.disabled = false;
                playButton.onclick = playGame;
                
                updateTimer();
                
                if (challengeMode && !autoMoveInterval) {
                    autoMoveInterval = setInterval(autoMoveClaw, 50);
                }
            }
            
            // Corrected startChallengeMode function
            function startChallengeMode() {
                const challengeBtn = document.getElementById('challenge-btn');
                const normalBtn = document.getElementById('normal-btn');
                if (gameActive) return;
                
                // Update mode state
                challengeMode = true;
                localStorage.setItem('gameMode', 'challenge');
                
                // Correct button states
                challengeBtn.disabled = true;    // Disable challenge button
                normalBtn.disabled = false;      // Enable normal button
                
                // Update visual indicators
                challengeBtn.classList.add('active-mode');
                normalBtn.classList.remove('active-mode');
                
                // Challenge mode specific setup
                timeLeft = 20;
                timerElement.textContent = timeLeft;
                slider.disabled = true;
                leftButton.disabled = false;
                rightButton.disabled = false;
                
                resetGame();
                
                // Start auto-moving
                autoMoveInterval = setInterval(autoMoveClaw, 50);
            }

            // Corrected switchToNormalMode function
            function switchToNormalMode() {
                const challengeBtn = document.getElementById('challenge-btn');
                const normalBtn = document.getElementById('normal-btn');
                if (gameActive) return;
                
                // Clear auto-move interval
                if (autoMoveInterval) {
                    clearInterval(autoMoveInterval);
                    autoMoveInterval = null;
                }
                
                // Update mode state
                challengeMode = false;
                localStorage.setItem('gameMode', 'normal');
                
                // Correct button states
                challengeBtn.disabled = false;   // Enable challenge button
                normalBtn.disabled = true;       // Disable normal button
                
                // Update visual indicators
                normalBtn.classList.add('active-mode');
                challengeBtn.classList.remove('active-mode');
                
                // Enable normal controls
                slider.disabled = false;
                
                // Normal mode specific setup
                timeLeft = 20;
                timerElement.textContent = timeLeft;
                
                resetGame();
            }

            // Simplify resetGame() - remove button state management from here:
            function resetGame() {
                gameActive = false;
                score = 0;
                timeLeft = challengeMode ? 20 : 20;
                scoreElement.textContent = `Prizes: ${score}`;
                timerElement.textContent = timeLeft;
                gameOverElement.style.display = 'none';

                // Reset claw position
                clawPosition = 50;
                updateClawPosition();
                slider.value = clawPosition;

                // Reset play button
                playButton.textContent = "START!";
                playButton.disabled = false;
                playButton.style.display = "inline-block";
                playButton.onclick = startGame;

                // Regenerate prizes
                regeneratePrizes();
            }
                                    
            function updateCableDrum() {
                const cableDrum = document.getElementById('cable-drum');
                const claw = document.getElementById('claw');
                const gameArea = document.getElementById('game-area');
                
                // Get actual pixel position of the claw
                const clawRect = claw.getBoundingClientRect();
                const gameRect = gameArea.getBoundingClientRect();
                
                // Calculate drum position relative to game area
                const relativeLeft = clawRect.left - gameRect.left;
                const percentage = (relativeLeft / gameRect.width) * 100;
                
                // Update drum position (horizontally only)
                cableDrum.style.left = `${percentage}%`;
                
                // Add slight rotation effect when moving
                const rotation = (clawPosition - 50) / 5; // More subtle rotation
                cableDrum.style.transform = `translateX(-50%) rotate(${rotation}deg)`;
            }
                   
            // Initialize game
            updateWire();
            randomizePrizePositions();
    
            // Assign functions to window object for button onclick handlers
            window.moveClaw = moveClaw;
            window.startChallengeMode = startChallengeMode;
            window.switchToNormalMode = switchToNormalMode;
            window.startGame = startGame;

            regeneratePrizes();
        });

        function submitScore() {
            const playerName = document.getElementById('player-name').value;
            if (!playerName.trim()) {
                alert('Please enter your name.');
                return; // Stop the function if no name is entered
            }
            const score = document.getElementById('final-score').textContent;
            fetch('/submit-score/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: `player_name=${encodeURIComponent(playerName)}&score=${score}`,
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    alert('Score saved successfully!');
                    window.location.reload(); // Reload the page after successful submission
                } else {
                    alert('Failed to save score.');
                }
            })
            .catch(error => {
                console.error('Error submitting score:', error);
                alert('An error occurred while submitting the score.');
            });
        }
        
        
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
    </script>

{% endblock content %}